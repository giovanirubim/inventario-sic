<html>
	<head>
		<title></title>
		<meta charset="utf-8"/>
	</head>
	<body>
		<canvas></canvas>
	</body>
</html>
<script type="text/javascript">

	var canvas = document.querySelector("canvas");
	var ctx = canvas.getContext("2d");
	var sx, sy, binM, imgData, data, bank, scnI;
	var marginTop = 95;
	var delta_y = 18;
	var cell_sx = 9;
	var cell_sy = 13;
	var colInfo = [
		{start_x: 143, dir: 1},
		{start_x: 649, dir: -1},
		{start_x: 898, dir: -1},
	];

	var scannRow = [];

	var loadBank = _ => {
		bank = window.localStorage.getItem("bank");
		if (!bank) {
			bank = {};
		} else {
			bank = JSON.parse(bank);
		}
	};
	var loadDict = _ => {
		dict = window.localStorage.getItem("dict");
		if (!dict) {
			dict = {
				"f:c:70:190:610:190:70:c": "A",
				"f:78:84:84:84:48": "c",
				"f:78:a4:a4:a4:68": "e",
				"f:ff:84:84:84:78": "p",
				"f:fc:80": "r",
				"f:78:84:84:84:78": "o",
				"f:c0:30:c:30:c0": "v",
				"f:fc:40:80:80:7c": "n",
				"f:3f8:404:404:444:448:27c": "G",
				"f:3f8:84": "t",
				"f:18:a4:a4:a4:7c": "a",
				"f:48:a4:94:48": "s",
				"f:208:404:444:444:3b8": "3",
				"f:3f8:404:404:404:3f8": "0",
				"f:fc:80:80:7c:80:80:7c": "m",
				"f:7fc": "l",
				"f:78:84:284:484:78": "ó",
				"f:4fc": "i",
				"f:7fc:444:444:444:3b8": "B",
				"f:78:84:84:84:ff": "q",
				"f:f8:4:4:8:fc": "u",
				"f:78:84:84:84:7fc": "d",
				"f:3f8:404:404:404:404:208": "C",
				"f:18:4:4:7f8": "J",
				"f:7c8:484:484:484:478": "5",
				"f:79:85:85:85:fe": "g",
				"f:3fc:480": "f",
				"f:7fc:404:404:404:208:1f0": "D",
				"f:7fc:440:440:440:440:380": "P",
				"f:20:20": "-",
				"f:3f8:444:444:444:238": "6",
				"f:18:a4:2a4:4a4:7c": "á",
				"f:400:400:7fc:400:400": "T",
				"f:200:200:7fc": "1",
				"f:30:d0:310:7fc:10": "4",
				"f:2:4": ",",
				"f:7fc:20:50:88:4": "k",
				"f:cc:30:30:cc": "x",
				"f:20c:414:424:444:384": "2",
				"f:7fc:4:4:4:4": "L",
				"f:218:4a4:6a4:2a4:47c": "ã",
				"f:8c:94:a4:c4": "z",
				"f:7fc:40:80:80:7c": "h",
				"f:7fc:440:440:440:440:3bc": "R",
				"f:7fc:440:440:440:400": "F",
				"f:7fc:84:84:84:78": "b",
				"f:4ff": "j",
				"f:4": ".",
				"f:3fe:401": "(",
				"f:401:3fe": ")",
				"f:388:444:444:444:238": "S",
				"f:400:41c:460:580:600": "7",
				"f:2fc:400": "í",
				"f:7fc:444:444:444:404": "E",
				"f:3b8:444:444:444:3b8": "8",
				"f:7fc:40:40:40:40:7fc": "H",
				"f:1:f1:e:8:f0": "y",
				"f:7fc:180:60:18:60:180:7fc": "M",
				"b:7fc:200:200": "1",
				"b:3b8:444:444:404:208": "3",
				"b:4:2": ",",
				"b:384:444:424:414:20c": "2",
				"b:118:224:7fe:244:188": "$",
				"b:3bc:440:440:440:440:7fc": "R",
				"b:3f8:404:404:404:3f8": "0",
				"b:478:484:484:484:7c8": "5",
				"b:10:7fc:310:d0:30": "4",
				"b:3f8:444:444:444:388": "9",
				"b:3b8:444:444:444:3b8": "8",
				"b:238:444:444:444:3f8": "6",
				"b:600:580:460:41c:400": "7",
			};
		} else {
			dict = JSON.parse(dict);
		}
	};
	var loadScnI = _ => {
		scnI = window.localStorage.getItem("scnI");
		if (!scnI) {
			scnI = {
				imgId: 1,
				rowIndex: 0,
				error: false,
				endOfPage: false,
				y: marginTop,
				colIndex: null,
				x: null,
				dir: null,
				buffer: "",
			};
		} else {
			scnI = JSON.parse(scnI);
		}
	};

	var saveScnI = _ => window.localStorage.setItem("scnI", JSON.stringify(scnI));
	var saveBank = _ => window.localStorage.setItem("bank", JSON.stringify(scnI));
	var saveDict = _ => window.localStorage.setItem("dict", JSON.stringify(scnI));

	var initRowScann = _ => {
		scnI.colIndex = 0;
		scnI.y = marginTop + delta_y*scnI.rowIndex;
		initColScann();
	};
	var initColScann = _ => {
		var i = scnI.colIndex;
		scnI.x = colInfo[i].start_x;
		scnI.dir = colInfo[i].dir;
	};
	var loadImgSrc = (src, callback) => {
		var img = document.createElement("img");
		img.onload = e => {
			img.remove();
			sx = canvas.width = img.width;
			sy = canvas.height = img.height;
			ctx.drawImage(img, 0, 0, sx, sy);
			imgData = ctx.getImageData(0, 0, sx, sy);
			data = imgData.data;
			callback();
		};
		img.src = src;
		document.body.appendChild(img);
	};
	var displayImageData = _ => {
		ctx.putImageData(imgData, 0, 0);
	};
	var removeBlueLine = _ => {
		for (var i=0; i<sy; ++i) {
			for (var j=0; j<sx; ++j) {
				var ri = (i*sx + j) << 2;
				var gi = ri + 1;
				var bi = gi + 1;
				var r = data[ri];
				var g = data[gi];
				var b = data[bi];
				if (r !== 0x33 || g !== 0x99 || b !== 0xff) {
					continue;
				}
				data[ri] = 255;
				data[gi] = 255;
				data[bi] = 254;
				for (var di=-1; di<=1; ++di) {
					for (var dj=-1; dj<=1; ++dj) {
						var ri = ((i + di)*sx + (j + dj)) << 2;
						var gi = ri + 1;
						var bi = gi + 1;
						if (data[ri] + data[gi] + data[bi] === 255*3) {
							data[ri] = data[gi] = data[bi] = 0;
						}
					}
				}
			}
		}
	};
	var binarize = _ => {
		binM = new Array(sy);
		for (var i=0; i<sy; ++i) {
			var row = new Array(sx);
			binM[i] = row;
			for (var j=0; j<sx; ++j) {
				var ri = (i*sx + j) << 2;
				var gi = ri + 1;
				var bi = gi + 1;
				var sum = data[ri] + data[gi] + data[bi];
				row[j] = (sum === 0) - 0;
				// data[ri] = data[gi] = data[bi] = row[j]*255;
			}
		}
	};
	var lastCode = "";
	var colors = ["#07f", "#f70", "#0af", "#f40"];
	var scannNextCell = () => {
		if (scnI.error || scnI.endOfPage) return;
		var y = scnI.y;
		var x = scnI.x;
		var dir = scnI.dir;
		ctx.fillStyle = "rgba(255,255,0,0.5)";
		if (dir > 0) {
			ctx.fillRect(x, y, cell_sx, cell_sy);
		} else {
			ctx.fillRect(x - cell_sx + 1, y, cell_sx, cell_sy);
		}
		var spaceBef = 0;
		var spaceAft = 0;
		var width = 0;
		var code = dir > 0 ? "f" : "b";
		var codeMatch = null;
		var strMatch = null;
		var split = false;
		var mask = 0;
		for (var n = cell_sx; n--; x += dir) {
			var prev = mask;
			mask = 0;
			for (var dy=0; dy<cell_sy; ++dy) {
				var bit = binM[y + dy][x];
				mask = (mask << 1) | bit;
				ctx.fillStyle = colors[(x&1)*2 + bit];
				ctx.fillRect(x, y + dy, 1, 1);
			}
			if (!mask) {
				if (!width) {
					spaceBef ++;
					continue;
				}
				spaceAft ++;
				split = true;
				break;
			}
			if (width > 0) {
				var a = prev | (prev << 1) | (prev << 2);
				var b = mask << 1;
				if ((a & b) === 0) {
					split = true;
					break;
				}
			}
			width ++;
			code += ":" + mask.toString(16);
		}
		if (spaceBef > 2) {
			if (width) {
				if (dir > 0) {
					scnI.buffer += " ";
				} else {
					scnI.buffer = " " + scnI.buffer;
				}
				scnI.x += dir*spaceBef;
				return;
			}
			if (scnI.buffer === "") {
				scnI.endOfPage = true;
				return;
			}
			console.log(scnI.buffer);
			scnI.buffer = "";
			if (++ scnI.colIndex >= colInfo.length) {
				++ scnI.rowIndex;
				initRowScann();
			} else {
				initColScann();
			}
			return;
		}
		var str = dict[code];
		if (!str) {
			scnI.error = true;
			lastCode = code;
			return;
		}
		if (dir > 0) {
			scnI.buffer += str;
		} else {
			scnI.buffer = str + scnI.buffer;
		}
		if (str === "1" && dir > 0) {
			width += 2;
		}
		scnI.x += dir*(width + spaceBef);
	};
	loadDict();
	loadScnI();
	loadImgSrc("img" + scnI.imgId + ".png", _ => {
		removeBlueLine();
		binarize();
		displayImageData();
		if (scnI.x === null) {
			initRowScann();
		}
		var code = setInterval(_=>{
			displayImageData();
			scannNextCell();
			if (scnI.error || scnI.endOfPage) {
				clearInterval(code);
				return;
			}
			saveScnI();
		}, 0);
	});
	window.onkeydown = e => {
		var key = e.key.toLowerCase();
		if (key === "\n" || key === "enter") {
			var txt = (prompt("")||"").trim();
			if (!txt) return;
			dict[lastCode] = txt;
			scnI.error = false;
			saveDict();
			window.location.reload();
			return;
		}
		if (key === " ") {
			var str = "";
			for (var att in dict) {
				str += "\t\"" + att + "\": " + JSON.stringify(dict[att]) + ",\n";
			}
			console.clear();
			console.log(str);
		}
	};
</script>