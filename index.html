<html>
	<head>
		<title></title>
		<meta charset="utf-8"/>
	</head>
	<body>
		<canvas></canvas>
	</body>
</html>
<script type="text/javascript">

	var canvas = document.querySelector("canvas");
	var ctx = canvas.getContext("2d");
	var sx, sy, binM, imgData, data, bank, scnI;
	var imageLoaded = false;
	var marginTop = 95;
	var delta_y = 18;
	var cell_sx = 70;
	var cell_sy = 13;
	var colInfo = [
		{start_x: 143, limit_x: 443},
		{start_x: 573, limit_x: 651},
		{start_x: 822, limit_x: 901}
	];

	var scannRow = [];

	var loadBank = _ => {
		bank = window.localStorage.getItem("bank");
		if (!bank) {
			bank = {};
		} else {
			bank = JSON.parse(bank);
		}
	};
	var loadDict = _ => {
		dict = window.localStorage.getItem("dict");
		if (!dict) {
			dict = {
				"4": ".",
				"c:70:190:610:190:70:c": "A",
				"78:84:84:84:48": "c",
				"78:a4:a4:a4:68": "e",
				"ff:84:84:84:78": "p",
				"fc:80": "r",
				"78:84:84:84:78": "o",
				"c0:30:c:30:c0": "v",
				"fc:40:80:80:7c": "n",
				"3f8:404:404:444:448:27c": "G",
				"3f8:84": "t",
				"18:a4:a4:a4:7c": "a",
				"48:a4:94:48": "s",
				"208:404:444:444:3b8": "3",
				"3f8:404:404:404:3f8": "0",
				"fc:80:80:7c:80:80:7c": "m",
				"7fc": "l",
				"78:84:284:484:78": "ó",
				"4fc": "i",
				"7fc:444:444:444:3b8": "B",
				"78:84:84:84:ff": "q",
				"f8:4:4:8:fc": "u",
				"78:84:84:84:7fc": "d",
				"3f8:404:404:404:404:208": "C",
				"18:4:4:7f8": "J",
				"7c8:484:484:484:478": "5",
				"79:85:85:85:fe": "g",
				"3fc:480": "f",
				"7fc:404:404:404:208:1f0": "D",
				"7fc:440:440:440:440:380": "P",
				"20:20": "-",
				"3f8:444:444:444:238": "6",
				"18:a4:2a4:4a4:7c": "á",
				"400:400:7fc:400:400": "T",
				"200:200:7fc": "1",
				"30:d0:310:7fc:10": "4",
				"2:4": ",",
				"7fc:20:50:88:4": "k",
				"cc:30:30:cc": "x",
				"20c:414:424:444:384": "2",
				"7fc:4:4:4:4": "L",
				"218:4a4:6a4:2a4:47c": "ã",
				"8c:94:a4:c4": "z",
				"7fc:40:80:80:7c": "h",
				"7fc:440:440:440:440:3bc": "R",
				"7fc:440:440:440:400": "F",
				"7fc:84:84:84:78": "b",
				"4ff": "j",
				"3fe:401": "(",
				"401:3fe": ")",
				"388:444:444:444:238": "S",
				"400:41c:460:580:600": "7",
				"2fc:400": "í",
				"7fc:444:444:444:404": "E",
				"3b8:444:444:444:3b8": "8",
				"7fc:40:40:40:40:7fc": "H",
				"1:f1:e:8:f0": "y",
				"7fc:180:60:18:60:180:7fc": "M",
				"188:244:7fe:224:118": "$",
				"388:444:444:444:3f8": "9",
			};
		} else {
			dict = JSON.parse(dict);
		}
	};
	var loadScnI = _ => {
		scnI = window.localStorage.getItem("scnI");
		if (!scnI) {
			scnI = {
				imgId: 1,
				rowIndex: 0,
				error: false,
				endOfPage: false,
				y: marginTop,
				colIndex: null,
				x: null,
				buffer: "",
			};
		} else {
			scnI = JSON.parse(scnI);
		}
		scnI.error = false;
	};

	var saveScnI = _ => window.localStorage.setItem("scnI", JSON.stringify(scnI));
	var saveBank = _ => window.localStorage.setItem("bank", JSON.stringify(bank));
	var saveDict = _ => window.localStorage.setItem("dict", JSON.stringify(dict));

	var initRowScann = _ => {
		scnI.colIndex = 0;
		scnI.y = marginTop + delta_y*scnI.rowIndex;
		initColScann();
	};
	var initColScann = _ => {
		var i = scnI.colIndex;
		scnI.x = colInfo[i].start_x;
	};
	var loadImgSrc = (src, callback) => {
		imageLoaded = false;
		var img = document.createElement("img");
		img.onload = e => {
			img.remove();
			sx = canvas.width = img.width;
			sy = canvas.height = img.height;
			ctx.drawImage(img, 0, 0, sx, sy);
			imgData = ctx.getImageData(0, 0, sx, sy);
			data = imgData.data;
			imageLoaded = true;
			callback();
		};
		img.src = src;
		document.body.appendChild(img);
	};
	var displayImageData = _ => {
		ctx.putImageData(imgData, 0, 0);
	};
	var removeBlueLine = _ => {
		for (var i=0; i<sy; ++i) {
			for (var j=0; j<sx; ++j) {
				var ri = (i*sx + j) << 2;
				var gi = ri + 1;
				var bi = gi + 1;
				var r = data[ri];
				var g = data[gi];
				var b = data[bi];
				if (r !== 0x33 || g !== 0x99 || b !== 0xff) {
					continue;
				}
				data[ri] = 255;
				data[gi] = 255;
				data[bi] = 254;
				for (var di=-1; di<=1; ++di) {
					for (var dj=-1; dj<=1; ++dj) {
						var ri = ((i + di)*sx + (j + dj)) << 2;
						var gi = ri + 1;
						var bi = gi + 1;
						if (data[ri] + data[gi] + data[bi] === 255*3) {
							data[ri] = data[gi] = data[bi] = 0;
						}
					}
				}
			}
		}
	};
	var binarize = _ => {
		binM = new Array(sy);
		for (var i=0; i<sy; ++i) {
			var row = new Array(sx);
			binM[i] = row;
			for (var j=0; j<sx; ++j) {
				var ri = (i*sx + j) << 2;
				var gi = ri + 1;
				var bi = gi + 1;
				var sum = data[ri] + data[gi] + data[bi];
				row[j] = (sum === 0) - 0;
				// data[ri] = data[gi] = data[bi] = row[j]*255;
			}
		}
	};
	var unknownCode = "";
	var colors = ["#07f", "#f70", "#0af", "#f40"];
	var scannCol = (x, y) => {
		var mask = 0;
		for (var i=y, e=y+cell_sy; i<e; ++i) {
			var bit = binM[i][x];
			mask = (mask << 1) | bit;
			ctx.fillStyle = colors[(x&1)*2 + bit];
			ctx.fillRect(x, i, 1, 1);
		}
		return mask;
	}
	var handleEndCol = _ => {
		console.log(scnI.buffer);
		if (++ scnI.colIndex >= colInfo.length) {
			scnI.rowIndex ++;
			initRowScann();
			scnI.endOfPage = scnI.y >= 977;
		} else {
			initColScann();
		}
		scnI.buffer = "";
	};
	var scannNextCell = () => {
		var x = scnI.x;
		var y = scnI.y;
		var mask;
		var space = 0;
		var limit = colInfo[scnI.colIndex].limit_x;
		while (x < limit && (mask = scannCol(x, y)) === 0) {
			++ x;
			++ space;
		}
		if (!mask) {
			handleEndCol();
			return;
		}
		var code = mask.toString(16);
		while (++x < limit) {
			var prev = mask;
			mask = scannCol(x, y);
			var a = prev | (prev << 1) | (prev << 2);
			var b = mask << 1;
			if ((a & b) === 0) {
				break;
			}
			code += ":" + mask.toString(16);
		}
		var str = dict[code];
		if (!str) {
			scnI.error = true;
			unknownCode = code;
			return;
		}
		if (space > 2) {
			scnI.buffer += " ";
		}
		scnI.buffer += str;
		scnI.x = x + (str === "1")*2;
	};

	loadDict();
	loadScnI();

	function step() {
		if (!imageLoaded) return;
		if (scnI.endOfPage && !scnI.error) {
			scnI.endOfPage = false;
			scnI.imgId ++;
			scnI.rowIndex = 0;
			initRowScann();
			loadImgSrc("img" + scnI.imgId + ".png", _=>{});
		} else if (scnI.error || scnI.endOfPage) {
			return;
		}
		displayImageData();
		scannNextCell();
		saveScnI();
	}

	loadImgSrc("img" + scnI.imgId + ".png", _ => {
		removeBlueLine();
		binarize();
		displayImageData();
		if (scnI.x === null) {
			initRowScann();
		}
		// step();
		setInterval(step, 0);
	});

	window.onkeydown = e => {
		var key = e.key.toLowerCase();
		if (key === "\n" || key === "enter") {
			var txt = (prompt("")||"").trim();
			if (!txt) return;
			dict[unknownCode] = txt;
			scnI.error = false;
			return;
		}
		if (key === " ") {
			e.preventDefault();
			e.stopPropagation();
			var str = "";
			for (var att in dict) {
				str += "\t\t\t\t\"" + att + "\": " + JSON.stringify(dict[att]) + ",\n";
			}
			console.clear();
			console.log(str);
			return;
		}
		// if (key.replace("arrow", "") === "right") {
		// 	step();
		// 	return;
		// }
	};
</script>